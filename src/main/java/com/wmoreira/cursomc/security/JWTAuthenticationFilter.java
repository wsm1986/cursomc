package com.wmoreira.cursomc.security;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Date;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.authentication.AuthenticationFailureHandler;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.wmoreira.cursomc.dto.CredenciaisDTO;
import com.wmoreira.cursomc.dto.Usuario;

public class JWTAuthenticationFilter extends UsernamePasswordAuthenticationFilter {

	private AuthenticationManager authenticationManager;

	private JWTUtil jwtUtil;

	public JWTAuthenticationFilter(AuthenticationManager authenticationManager, JWTUtil jwtUtil) {
		setAuthenticationFailureHandler(new JWTAuthenticationFailureHandler());
		this.authenticationManager = authenticationManager;
		this.jwtUtil = jwtUtil;
	}

	@Override
	public Authentication attemptAuthentication(HttpServletRequest req, HttpServletResponse res)
			throws AuthenticationException {

		try {
			CredenciaisDTO creds = new ObjectMapper().readValue(req.getInputStream(), CredenciaisDTO.class);

			UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(creds.getEmail(),
					creds.getSenha(), new ArrayList<>());

			Authentication auth = authenticationManager.authenticate(authToken);
			return auth;
		} catch (IOException e) {
			throw new RuntimeException(e);
		}
	}

	@Override
	protected void successfulAuthentication(HttpServletRequest req, HttpServletResponse res, FilterChain chain,
			Authentication auth) throws IOException, ServletException {

		UserSpringSecurity user = ((UserSpringSecurity) auth.getPrincipal());
		String token = jwtUtil.generateToken(user.getUsername());
		res.addHeader("Authorization", "Bearer " + token);
		
		String urlFoto = "data:image/png;base64,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";
		Usuario usuarioLogado = new Usuario(
				user.getUsername(), user.getNome(), user.getUsername(), urlFoto, token, user.getRoles());
				
		// Creating Object of ObjectMapper define in Jakson Api
		ObjectMapper Obj = new ObjectMapper();

		// get Oraganisation object as a json string
		String jsonStr = Obj.writeValueAsString(usuarioLogado);

		res.getOutputStream().write(jsonStr.toString().getBytes());
		res.flushBuffer();
	}

	private class JWTAuthenticationFailureHandler implements AuthenticationFailureHandler {

		@Override
		public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response,
				AuthenticationException exception) throws IOException, ServletException {
			response.setStatus(401);
			response.setContentType("application/json");
			response.getWriter().append(json());
		}

		private String json() {
			long date = new Date().getTime();
			return "{\"timestamp\": " + date + ", " + "\"status\": 401, " + "\"error\": \"Não autorizado\", "
					+ "\"message\": \"Email ou senha inválidos\", " + "\"path\": \"/login\"}";
		}
	}
}